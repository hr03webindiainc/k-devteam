
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safiery Quote Management</title>
    <script src="https://cdn.tailwindcss.com" type="0a289f235e50cac5cfa48845-text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" type="0a289f235e50cac5cfa48845-text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .search-results {
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100">
    
    <div class="container mx-auto p-6">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold text-blue-900">üí∞ Quote Management</h1>
                <div class="space-x-2">
                    <a class='bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600' href='/'>‚Üê Back to Configurator</a>
                    <button id="newQuoteBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">+ New Quote</button>
                </div>
            </div>
            
            <div id="quotesListContainer">
                <!-- Quotes will be listed here -->
            </div>
        </div>
    </div>

    <!-- Quote Editor Modal -->
    <div id="quoteEditorModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-7xl max-h-[95vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold" id="quoteEditorTitle">üìã New Quote</h2>
                <button id="closeQuoteEditorBtn" class="text-3xl font-bold hover:text-red-500">&times;</button>
            </div>
            
            <!-- Quote Header Info -->
            <div class="bg-gray-50 p-4 rounded-lg mb-4 grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold mb-1">Quote Name:</label>
                    <input type="text" id="quoteNameInput" class="w-full border-2 border-gray-300 rounded p-2" placeholder="E.g., MC86 Port Side System">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">Customer Name:</label>
                    <input type="text" id="customerNameInput" class="w-full border-2 border-gray-300 rounded p-2" placeholder="E.g., John Smith">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">Boat Name:</label>
                    <input type="text" id="boatNameInput" class="w-full border-2 border-gray-300 rounded p-2" placeholder="E.g., Sea Voyager">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">Notes:</label>
                    <input type="text" id="quoteNotesInput" class="w-full border-2 border-gray-300 rounded p-2" placeholder="Optional notes">
                </div>
            </div>
            
            <!-- Configuration Link -->
            <div id="configLinkSection" class="hidden bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-semibold text-blue-900">üìê Linked Configuration</p>
                        <p class="text-sm text-blue-700" id="configLinkText">Configuration saved with this quote</p>
                    </div>
                    <div class="space-x-2">
                        <button id="viewConfigBtn" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 text-sm">üîß Open in Configurator</button>
                        <button id="viewDiagramsBtn" class="bg-purple-600 text-white px-3 py-2 rounded hover:bg-purple-700 text-sm">üìä View Diagrams</button>
                    </div>
                </div>
            </div>
            
            <!-- Line Items -->
            <div class="flex-grow overflow-y-auto border-2 border-gray-300 rounded-lg p-4 mb-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-bold">Line Items</h3>
                    <div class="relative">
                        <button id="addProductBtn" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">+ Add Product</button>
                        <div id="productSearchDropdown" class="hidden absolute right-0 top-full mt-2 w-96 bg-white border-2 border-blue-500 rounded-lg shadow-xl z-50">
                            <input type="text" id="productSearchInput" class="w-full p-3 border-b-2 border-gray-200" placeholder="Search products...">
                            <div id="productSearchResults" class="search-results p-2">
                                <!-- Search results will appear here -->
                            </div>
                        </div>
                    </div>
                </div>
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="p-2 border">SKU</th>
                            <th class="p-2 border">Description</th>
                            <th class="p-2 border">Qty</th>
                            <th class="p-2 border">Unit Price</th>
                            <th class="p-2 border">Total</th>
                            <th class="p-2 border w-20">Action</th>
                        </tr>
                    </thead>
                    <tbody id="quoteLineItemsTable">
                        <!-- Line items will be added here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Totals -->
            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <div class="flex justify-end space-x-8 text-lg">
                    <span class="font-semibold">Subtotal:</span>
                    <span id="quoteSubtotal" class="font-bold">$0.00</span>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="flex space-x-2">
                <button id="saveQuoteBtn" class="flex-1 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700">üíæ Save Quote</button>
                <button id="downloadQuotePdfBtn" class="flex-1 bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700">üìÑ Download PDF</button>
                <button id="convertToInvoiceBtn" class="flex-1 bg-orange-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-orange-700">üöÄ Convert to Invoice</button>
            </div>
        </div>
    </div>

    <!-- Diagrams Viewer Modal -->
    <div id="diagramsModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-6xl max-h-[95vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">üìä Configuration Diagrams</h2>
                <button id="closeDiagramsBtn" class="text-3xl font-bold hover:text-red-500">&times;</button>
            </div>
            <div id="diagramsContent" class="flex-grow overflow-y-auto space-y-4">
                <!-- Diagrams will be displayed here -->
            </div>
        </div>
    </div>

    <script type="0a289f235e50cac5cfa48845-text/javascript">
        // Complete product catalog
        const PRODUCT_CATALOG = {
            // Hardware
            'STAR-light-MATTER': { name: 'STAR-Light V2 (Matter)', price: 890, category: 'Output Modules' },
            'STAR-power-Matter-150': { name: 'STAR-Power (Matter 150A)', price: 924, category: 'Output Modules' },
            'STAR-Rover-4': { name: 'STAR-Rover-4', price: 650, category: 'Output Modules' },
            'STAR-switch-SP4-wireless-bat': { name: 'STAR-Switch SP4 Wireless', price: 206.85, category: 'Input Switches' },
            'STAR-Switch-SP8': { name: 'STAR-Switch SP8 CAN-Bus', price: 204.75, category: 'Input Switches' },
            
            // NMEA Cables
            '010-11076-00': { name: 'NMEA Cable 2m', price: 49, category: 'CAN-Bus Cables' },
            '010-11076-01': { name: 'NMEA Cable 5m', price: 55, category: 'CAN-Bus Cables' },
            '010-11076-02': { name: 'NMEA Cable 10m', price: 85, category: 'CAN-Bus Cables' },
            '010-11076-03': { name: 'NMEA Dropper 0.3m', price: 39, category: 'CAN-Bus Accessories' },
            
            // Accessories
            '010-11078-00': { name: 'NMEA T-Connector', price: 39, category: 'CAN-Bus Accessories' },
            'NMEA-Terminator-Pair': { name: 'NMEA Terminator Pair', price: 25, category: 'CAN-Bus Accessories' },
            'NMEA-vecan-joiner-1': { name: 'NMEA VE-CAN Kit', price: 282.10, category: 'CAN-Bus Accessories' },
            
            // Additional common items
            'WIRE-14AWG-RED': { name: '14 AWG Red Wire (per meter)', price: 2.50, category: 'Wire & Cable' },
            'WIRE-14AWG-BLACK': { name: '14 AWG Black Wire (per meter)', price: 2.50, category: 'Wire & Cable' },
            'WIRE-10AWG-RED': { name: '10 AWG Red Wire (per meter)', price: 3.80, category: 'Wire & Cable' },
            'WIRE-10AWG-BLACK': { name: '10 AWG Black Wire (per meter)', price: 3.80, category: 'Wire & Cable' },
            'FUSE-HOLDER-ANL': { name: 'ANL Fuse Holder', price: 15.00, category: 'Protection' },
            'FUSE-ANL-100A': { name: '100A ANL Fuse', price: 8.00, category: 'Protection' },
            'FUSE-ANL-150A': { name: '150A ANL Fuse', price: 8.50, category: 'Protection' },
            'BUSBAR-100A': { name: '100A Busbar', price: 35.00, category: 'Distribution' },
            'BUSBAR-150A': { name: '150A Busbar', price: 45.00, category: 'Distribution' },
            'INSTALL-LABOR': { name: 'Installation Labor (per hour)', price: 125.00, category: 'Services' },
            'COMMISSIONING': { name: 'System Commissioning', price: 500.00, category: 'Services' }
        };

        // Local storage for quotes
        let quotes = JSON.parse(localStorage.getItem('safiery_quotes') || '[]');
        let currentEditingQuote = null;
        
        function init() {
            renderQuotesList();
            
            document.getElementById('newQuoteBtn').addEventListener('click', () => openQuoteEditor(null));
            document.getElementById('closeQuoteEditorBtn').addEventListener('click', closeQuoteEditor);
            document.getElementById('addProductBtn').addEventListener('click', toggleProductSearch);
            document.getElementById('productSearchInput').addEventListener('input', handleProductSearch);
            document.getElementById('saveQuoteBtn').addEventListener('click', saveQuote);
            document.getElementById('downloadQuotePdfBtn').addEventListener('click', downloadQuotePdf);
            document.getElementById('convertToInvoiceBtn').addEventListener('click', convertToInvoice);
            document.getElementById('viewConfigBtn').addEventListener('click', openInConfigurator);
            document.getElementById('viewDiagramsBtn').addEventListener('click', viewDiagrams);
            document.getElementById('closeDiagramsBtn').addEventListener('click', () => document.getElementById('diagramsModal').classList.add('hidden'));
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('productSearchDropdown');
                const addBtn = document.getElementById('addProductBtn');
                if (!dropdown.contains(e.target) && e.target !== addBtn) {
                    dropdown.classList.add('hidden');
                }
            });
        }
        
        function renderQuotesList() {
            const container = document.getElementById('quotesListContainer');
            
            if (quotes.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">No quotes yet. Create your first quote!</p>';
                return;
            }
            
            let html = '<table class="w-full border-collapse">';
            html += '<thead><tr class="bg-gray-100">';
            html += '<th class="p-3 border text-left">ID</th>';
            html += '<th class="p-3 border text-left">Name</th>';
            html += '<th class="p-3 border text-left">Customer</th>';
            html += '<th class="p-3 border text-left">Boat</th>';
            html += '<th class="p-3 border text-right">Total</th>';
            html += '<th class="p-3 border text-center">Config</th>';
            html += '<th class="p-3 border text-center">Diagrams</th>';
            html += '<th class="p-3 border text-center">Status</th>';
            html += '<th class="p-3 border text-center">Actions</th>';
            html += '</tr></thead><tbody>';
            
            quotes.forEach(quote => {
                const statusColors = {
                    draft: 'bg-gray-100 text-gray-800',
                    sent: 'bg-green-100 text-green-800',
                    invoice: 'bg-orange-100 text-orange-800'
                };
                const hasConfig = quote.configurationSnapshot ? '‚úÖ' : '‚ùå';
                const hasDiagrams = quote.diagrams && (quote.diagrams.networkDiagram || quote.diagrams.summaryImage) ? '‚úÖ' : '‚ùå';
                
                html += '<tr class="hover:bg-gray-50">';
                html += `<td class="p-3 border">#${quote.id}</td>`;
                html += `<td class="p-3 border font-semibold">${quote.name}</td>`;
                html += `<td class="p-3 border">${quote.customerName || 'N/A'}</td>`;
                html += `<td class="p-3 border">${quote.boatName || 'N/A'}</td>`;
                html += `<td class="p-3 border text-right font-bold">${quote.subtotal.toFixed(2)}</td>`;
                html += `<td class="p-3 border text-center">${hasConfig}</td>`;
                html += `<td class="p-3 border text-center">${hasDiagrams}</td>`;
                html += `<td class="p-3 border text-center"><span class="${statusColors[quote.status]} px-2 py-1 rounded text-xs font-semibold">${quote.status}</span></td>`;
                html += `<td class="p-3 border text-center space-x-1">`;
                html += `<button class="bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 text-xs" onclick="openQuoteEditor(${quote.id})">Edit</button>`;
                html += `<button class="bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600 text-xs" onclick="downloadQuotePdfById(${quote.id})">PDF</button>`;
                html += `<button class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 text-xs" onclick="deleteQuote(${quote.id})">Delete</button>`;
                html += `</td></tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function openQuoteEditor(quoteId) {
            currentEditingQuote = quoteId;
            
            if (quoteId === null) {
                document.getElementById('quoteEditorTitle').textContent = 'üìã New Quote';
                document.getElementById('quoteNameInput').value = '';
                document.getElementById('customerNameInput').value = '';
                document.getElementById('boatNameInput').value = '';
                document.getElementById('quoteNotesInput').value = '';
                document.getElementById('configLinkSection').classList.add('hidden');
                renderLineItems([]);
            } else {
                const quote = quotes.find(q => q.id === quoteId);
                document.getElementById('quoteEditorTitle').textContent = `üìã Edit Quote #${quote.id}`;
                document.getElementById('quoteNameInput').value = quote.name;
                document.getElementById('customerNameInput').value = quote.customerName || '';
                document.getElementById('boatNameInput').value = quote.boatName || '';
                document.getElementById('quoteNotesInput').value = quote.notes || '';
                
                if (quote.configurationSnapshot) {
                    document.getElementById('configLinkSection').classList.remove('hidden');
                    document.getElementById('configLinkText').textContent = `Configuration saved: ${quote.configurationSnapshot.boatType} - ${quote.configurationSnapshot.placedComponents.length} components`;
                    
                    // Enable/disable diagrams button based on availability
                    const viewDiagramsBtn = document.getElementById('viewDiagramsBtn');
                    const hasDiagrams = quote.diagrams && (quote.diagrams.networkDiagram || quote.diagrams.summaryImage);
                    viewDiagramsBtn.disabled = !hasDiagrams;
                    viewDiagramsBtn.className = hasDiagrams 
                        ? 'bg-purple-600 text-white px-3 py-2 rounded hover:bg-purple-700 text-sm'
                        : 'bg-gray-400 text-white px-3 py-2 rounded cursor-not-allowed text-sm';
                } else {
                    document.getElementById('configLinkSection').classList.add('hidden');
                }
                
                renderLineItems(quote.lineItems);
            }
            
            document.getElementById('quoteEditorModal').classList.remove('hidden');
        }
        
        function closeQuoteEditor() {
            document.getElementById('quoteEditorModal').classList.add('hidden');
        }
        
        function toggleProductSearch() {
            const dropdown = document.getElementById('productSearchDropdown');
            dropdown.classList.toggle('hidden');
            if (!dropdown.classList.contains('hidden')) {
                document.getElementById('productSearchInput').focus();
                handleProductSearch(); // Show all products initially
            }
        }
        
        function handleProductSearch() {
            const searchTerm = document.getElementById('productSearchInput').value.toLowerCase();
            const results = document.getElementById('productSearchResults');
            
            let html = '';
            const categories = {};
            
            // Group by category
            Object.entries(PRODUCT_CATALOG).forEach(([sku, product]) => {
                if (searchTerm === '' || 
                    product.name.toLowerCase().includes(searchTerm) || 
                    sku.toLowerCase().includes(searchTerm) ||
                    product.category.toLowerCase().includes(searchTerm)) {
                    
                    if (!categories[product.category]) {
                        categories[product.category] = [];
                    }
                    categories[product.category].push({ sku, ...product });
                }
            });
            
            // Render by category
            Object.entries(categories).forEach(([category, products]) => {
                html += `<div class="mb-2"><div class="font-bold text-sm text-gray-600 px-2 py-1 bg-gray-100">${category}</div>`;
                products.forEach(product => {
                    html += `<div class="p-2 hover:bg-blue-50 cursor-pointer border-b" onclick="addProductToQuote('${product.sku}')">`;
                    html += `<div class="font-semibold">${product.name}</div>`;
                    html += `<div class="text-xs text-gray-500">${product.sku} - $${product.price.toFixed(2)}</div>`;
                    html += `</div>`;
                });
                html += '</div>';
            });
            
            if (html === '') {
                html = '<p class="text-center text-gray-500 py-4">No products found</p>';
            }
            
            results.innerHTML = html;
        }
        
        window.addProductToQuote = function(sku) {
            const product = PRODUCT_CATALOG[sku];
            if (!product) return;
            
            const items = getCurrentLineItems();
            
            // Check if product already exists
            const existingItem = items.find(item => item.sku === sku);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                items.push({
                    sku: sku,
                    description: product.name,
                    quantity: 1,
                    unitPrice: product.price
                });
            }
            
            renderLineItems(items);
            document.getElementById('productSearchDropdown').classList.add('hidden');
            document.getElementById('productSearchInput').value = '';
        };
        
        function renderLineItems(items) {
            const tbody = document.getElementById('quoteLineItemsTable');
            tbody.innerHTML = '';
            
            items.forEach((item, idx) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="p-2 border">${item.sku}</td>
                    <td class="p-2 border">${item.description}</td>
                    <td class="p-2 border">
                        <input type="number" class="w-20 p-1 border rounded" value="${item.quantity}" min="1" data-idx="${idx}" data-field="quantity">
                    </td>
                    <td class="p-2 border">$${item.unitPrice.toFixed(2)}</td>
                    <td class="p-2 border font-semibold">$${(item.quantity * item.unitPrice).toFixed(2)}</td>
                    <td class="p-2 border text-center">
                        <button class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 text-xs" onclick="deleteLine(${idx})">√ó</button>
                    </td>
                `;
            });
            
            updateSubtotal();
        }
        
        function getCurrentLineItems() {
            const items = [];
            document.querySelectorAll('#quoteLineItemsTable tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 4) {
                    const qtyInput = row.querySelector('input[data-field="quantity"]');
                    items.push({
                        sku: cells[0].textContent,
                        description: cells[1].textContent,
                        quantity: parseFloat(qtyInput.value) || 0,
                        unitPrice: parseFloat(cells[3].textContent.replace('$', '')) || 0
                    });
                }
            });
            return items;
        }
        
        window.deleteLine = function(idx) {
            const items = getCurrentLineItems();
            items.splice(idx, 1);
            renderLineItems(items);
        };
        
        function updateSubtotal() {
            const items = getCurrentLineItems();
            const subtotal = items.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);
            document.getElementById('quoteSubtotal').textContent = '$' + subtotal.toFixed(2);
        }
        
        document.addEventListener('input', (e) => {
            if (e.target.dataset.field === 'quantity') {
                updateSubtotal();
            }
        });
        
        function saveQuote() {
            const name = document.getElementById('quoteNameInput').value.trim();
            if (!name) return alert('Please enter a quote name');
            
            const items = getCurrentLineItems();
            if (items.length === 0) return alert('Please add at least one line item');
            
            let existingQuote = null;
            if (currentEditingQuote) {
                existingQuote = quotes.find(q => q.id === currentEditingQuote);
            }
            
            const quote = {
                id: currentEditingQuote || Date.now(),
                name,
                customerName: document.getElementById('customerNameInput').value,
                boatName: document.getElementById('boatNameInput').value,
                notes: document.getElementById('quoteNotesInput').value,
                lineItems: items,
                subtotal: items.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0),
                status: existingQuote ? existingQuote.status : 'draft',
                createdAt: existingQuote ? existingQuote.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                configurationSnapshot: existingQuote ? existingQuote.configurationSnapshot : null,
                diagrams: existingQuote ? existingQuote.diagrams : null
            };
            
            if (currentEditingQuote) {
                const idx = quotes.findIndex(q => q.id === currentEditingQuote);
                quotes[idx] = quote;
            } else {
                quotes.push(quote);
            }
            
            localStorage.setItem('safiery_quotes', JSON.stringify(quotes));
            alert('Quote saved successfully!');
            closeQuoteEditor();
            renderQuotesList();
        }
        
        function deleteQuote(id) {
            if (!confirm('Delete this quote?')) return;
            quotes = quotes.filter(q => q.id !== id);
            localStorage.setItem('safiery_quotes', JSON.stringify(quotes));
            renderQuotesList();
        }
        
        function downloadQuotePdf() {
            const quote = getCurrentQuoteData();
            if (!quote) return;
            generatePDF(quote);
        }
        
        window.downloadQuotePdfById = function(id) {
            const quote = quotes.find(q => q.id === id);
            if (!quote) return;
            generatePDF(quote);
        };
        
        function getCurrentQuoteData() {
            const name = document.getElementById('quoteNameInput').value.trim();
            if (!name) {
                alert('Please enter a quote name');
                return null;
            }
            
            const items = getCurrentLineItems();
            if (items.length === 0) {
                alert('Please add at least one line item');
                return null;
            }
            
            return {
                id: currentEditingQuote || Date.now(),
                name,
                customerName: document.getElementById('customerNameInput').value,
                boatName: document.getElementById('boatNameInput').value,
                notes: document.getElementById('quoteNotesInput').value,
                lineItems: items,
                subtotal: items.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0),
                createdAt: new Date().toISOString()
            };
        }
        
        function generatePDF(quote) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFontSize(24);
            doc.setTextColor(58, 109, 174);
            doc.text('SAFIERY', 20, 20);
            
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text('Marine Electronics & Digital Switching Systems', 20, 27);
            
            // Quote Title
            doc.setFontSize(18);
            doc.setTextColor(0, 0, 0);
            doc.text('QUOTATION', 150, 20);
            
            doc.setFontSize(10);
            doc.text(`Quote #${quote.id}`, 150, 27);
            doc.text(`Date: ${new Date(quote.createdAt).toLocaleDateString()}`, 150, 32);
            
            // Line
            doc.setDrawColor(226, 131, 37);
            doc.setLineWidth(1);
            doc.line(20, 38, 190, 38);
            
            // Customer Info
            let y = 50;
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('Customer Information:', 20, y);
            doc.setFont(undefined, 'normal');
            y += 6;
            doc.text(`Name: ${quote.customerName || 'N/A'}`, 20, y);
            y += 5;
            doc.text(`Boat: ${quote.boatName || 'N/A'}`, 20, y);
            y += 5;
            if (quote.notes) {
                doc.text(`Notes: ${quote.notes}`, 20, y);
                y += 5;
            }
            
            // Quote Name
            y += 5;
            doc.setFont(undefined, 'bold');
            doc.setFontSize(12);
            doc.text(quote.name, 20, y);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);
            
            // Table Header
            y += 10;
            doc.setFillColor(243, 244, 246);
            doc.rect(20, y, 170, 8, 'F');
            doc.setFont(undefined, 'bold');
            doc.text('SKU', 22, y + 5);
            doc.text('Description', 60, y + 5);
            doc.text('Qty', 135, y + 5);
            doc.text('Unit Price', 150, y + 5);
            doc.text('Total', 180, y + 5);
            doc.setFont(undefined, 'normal');
            
            // Line Items
            y += 8;
            quote.lineItems.forEach(item => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.text(item.sku, 22, y + 5);
                
                // Wrap long descriptions
                const descLines = doc.splitTextToSize(item.description, 70);
                doc.text(descLines, 60, y + 5);
                
                doc.text(item.quantity.toString(), 135, y + 5);
                doc.text(`$${item.unitPrice.toFixed(2)}`, 150, y + 5);
                doc.text(`$${(item.quantity * item.unitPrice).toFixed(2)}`, 180, y + 5);
                
                const lineHeight = Math.max(6, descLines.length * 5);
                y += lineHeight;
                
                // Line separator
                doc.setDrawColor(220, 220, 220);
                doc.line(20, y, 190, y);
            });
            
            // Subtotal
            y += 10;
            doc.setFont(undefined, 'bold');
            doc.setFontSize(12);
            doc.text('Subtotal:', 150, y);
            doc.text(`$${quote.subtotal.toFixed(2)}`, 180, y);
            
            // Footer
            y = 280;
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(100, 100, 100);
            doc.text('Thank you for your business!', 105, y, { align: 'center' });
            doc.text('Safiery Marine Electronics | www.safiery.com | info@safiery.com', 105, y + 5, { align: 'center' });
            
            // Save
            doc.save(`Safiery_Quote_${quote.id}.pdf`);
        }
        
        function convertToInvoice() {
            if (!confirm('Convert to invoice and send to Safiery?')) return;
            
            alert('Invoice conversion triggered!\n\nIn production, this would:\n1. Create invoice in your system\n2. Send to Safiery\n3. Email customer\n4. Update status');
            
            if (currentEditingQuote) {
                const quote = quotes.find(q => q.id === currentEditingQuote);
                quote.status = 'invoice';
                localStorage.setItem('safiery_quotes', JSON.stringify(quotes));
            }
        }
        
        function openInConfigurator() {
            if (!currentEditingQuote) return;
            
            const quote = quotes.find(q => q.id === currentEditingQuote);
            if (!quote || !quote.configurationSnapshot) {
                alert('No configuration found for this quote');
                return;
            }
            
            // Save configuration to temporary storage for the configurator to load
            localStorage.setItem('tempLoadConfig', JSON.stringify(quote.configurationSnapshot));
            
            // Open configurator in new tab
            window.open('index.html?loadTemp=true', '_blank');
        }
        
        function viewDiagrams() {
            if (!currentEditingQuote) return;
            
            const quote = quotes.find(q => q.id === currentEditingQuote);
            console.log('Viewing diagrams for quote:', quote);
            console.log('Has diagrams object?', !!quote.diagrams);
            if (quote.diagrams) {
                console.log('Has network diagram?', !!quote.diagrams.networkDiagram);
                console.log('Has summary image?', !!quote.diagrams.summaryImage);
            }
            
            if (!quote || !quote.diagrams) {
                alert('No diagrams found for this quote.\n\nTip: Diagrams are automatically saved when you:\n1. Configure channels in the system\n2. Design the CAN-bus network\n3. Generate the quote');
                return;
            }
            
            const container = document.getElementById('diagramsContent');
            let html = '';
            let hasAnyDiagram = false;
            
            if (quote.diagrams.networkDiagram) {
                hasAnyDiagram = true;
                html += '<div class="border-2 border-gray-300 rounded-lg p-4 bg-white">';
                html += '<h3 class="font-bold text-lg mb-2">üîå CAN-Bus Network Diagram</h3>';
                html += '<div class="overflow-auto">';
                html += quote.diagrams.networkDiagram;
                html += '</div>';
                html += '</div>';
            }
            
            if (quote.diagrams.summaryImage) {
                hasAnyDiagram = true;
                html += '<div class="border-2 border-gray-300 rounded-lg p-4 bg-white">';
                html += '<h3 class="font-bold text-lg mb-2">üìä Configuration Summary</h3>';
                html += `<img src="${quote.diagrams.summaryImage}" class="w-full" />`;
                html += '</div>';
            }
            
            if (!hasAnyDiagram) {
                html = '<div class="text-center py-8">';
                html += '<p class="text-gray-500 text-lg mb-4">üì≠ No diagrams available for this quote</p>';
                html += '<p class="text-sm text-gray-600">Diagrams are automatically captured when generating quotes from the configurator if:</p>';
                html += '<ul class="text-sm text-gray-600 mt-2 text-left max-w-md mx-auto">';
                html += '<li class="mb-1">‚úÖ Channels are configured on output modules</li>';
                html += '<li class="mb-1">‚úÖ CAN-bus network is designed and valid</li>';
                html += '</ul>';
                html += '</div>';
            }
            
            container.innerHTML = html;
            document.getElementById('diagramsModal').classList.remove('hidden');
        }
        
        init();
    </script>
<script src="/cdn-cgi/scripts/7d0fa10a/cloudflare-static/rocket-loader.min.js" data-cf-settings="0a289f235e50cac5cfa48845-|49" defer></script><script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"d06d29c2f8824eeba59eab28f0766b58","server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>